(def alert
  "Send alerts to teams"
  <% if_p("riemann.victorops.apikey") do %>
    (let [vo (victorops "<%= p("riemann.victorops.apikey") %>", "<%= p("riemann.victorops.routingkey") %>")]
      (by [:host :service]
        (where (not (state "expired"))
          (changed-state {:init "ok"}
            (where (state "ok") (:recover vo))
            (where (state "critical") (:trigger vo))
          )
        )
      )
    )
  <% else %>
  (
    where
    (
      and
      (or (state "warning") (state "critical") (state "blocker"))
      (not (service #"bosh_test*"))
    )

    ( where (host #".*framefrog.*")   tell-framefrog )
    ( where (host #".*predictor.*")   tell-predictor )
    ( where (host #".*wombats.*")     tell-wombats )

    tell-idefix
  )
  <% end %>
)
